# =============================================================================
# Dependency Mapping Platform - Redis Configuration
# TASK-DEV-003: Redis 7+ with Streams for caching and event queuing
# =============================================================================

# -----------------------------------------------------------------------------
# Network
# -----------------------------------------------------------------------------
bind 0.0.0.0
port 6379
protected-mode no

# -----------------------------------------------------------------------------
# Persistence - AOF (Append Only File)
# -----------------------------------------------------------------------------
appendonly yes
appendfsync everysec
auto-aof-rewrite-percentage 100
auto-aof-rewrite-min-size 64mb

# -----------------------------------------------------------------------------
# Persistence - RDB Snapshots
# -----------------------------------------------------------------------------
# Save if at least 1000 keys changed in 60 seconds
save 60 1000
# Save if at least 100 keys changed in 300 seconds (5 min)
save 300 100
# Save if at least 1 key changed in 900 seconds (15 min)
save 900 1

rdbcompression yes
rdbchecksum yes

# -----------------------------------------------------------------------------
# Memory Management
# -----------------------------------------------------------------------------
# Default 256MB for development - override via REDIS_MAXMEMORY env
maxmemory 256mb
maxmemory-policy allkeys-lru

# Memory sampling for eviction
maxmemory-samples 5

# -----------------------------------------------------------------------------
# Streams Configuration (for scan events)
# -----------------------------------------------------------------------------
# Max bytes per radix tree node
stream-node-max-bytes 4096
# Max entries per radix tree node
stream-node-max-entries 100

# -----------------------------------------------------------------------------
# Logging
# -----------------------------------------------------------------------------
loglevel notice
logfile ""

# -----------------------------------------------------------------------------
# Performance Tuning
# -----------------------------------------------------------------------------
# TCP keepalive
tcp-keepalive 300

# Disable THP warning (handled by Docker)
activedefrag no

# Lazy freeing for better performance
lazyfree-lazy-eviction yes
lazyfree-lazy-expire yes
lazyfree-lazy-server-del yes

# -----------------------------------------------------------------------------
# Client Handling
# -----------------------------------------------------------------------------
timeout 0
tcp-backlog 511
